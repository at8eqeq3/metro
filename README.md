# Метро

Набор данных, [честно потыренный](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B9_%D0%9C%D0%BE%D1%81%D0%BA%D0%BE%D0%B2%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B5%D0%BD%D0%B0,_%D0%9C%D0%BE%D1%81%D0%BA%D0%BE%D0%B2%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D0%BC%D0%BE%D0%BD%D0%BE%D1%80%D0%B5%D0%BB%D1%8C%D1%81%D0%B0_%D0%B8_%D0%9C%D0%A6%D0%9A) из Википедии и аккуратно подпиленный руками, содержащий сведения о станциях Московского метрополитена: географические координаты, периоды работы, принадлежность к линиям.

К данным прилагается небольшой скрипт на Python, позволяющий слепить из них серию картинок с картой метро в интервале между заданными датами с шагом в 1 календарный месяц. Из картинок потом при желании можно слепить видео (ffmpeg наш друг, как-то так, например: `ffmpeg -thread_queue_size 4096 -r 8 -pattern_type glob -i "png/metro-*.png" -i palette.png -filter_complex paletteuse -r 8 output.gif
`).

Теоретически, можно собрать набор данных для любого другого метрополитена или ещё чего-нибудь, и сгенерировать хронологические картинки. Важно при этом обратить внимание, что в скрипте жёстко закодирован коэффициент преобразования координат в единицы длины, и соответствует он широте Москвы. Для других городов он будет отличаться.

## Схема данных

Данные хранятся в формате YAML в трёх файлах -- lines.yaml, stations2.yaml и yaml.sections2.

### 1. Станции

    - name: "Тушинская"
      dates:
      - since: 1975-12-30
      lines:
      - name: "7TKL"
        since: 1975-12-30
      coords:
        lat: 55.8267
        lon: 37.4368

Последовательность из станций, каждая станция суть сопоставление с ключами:

* `name` -- название станции
* `dates` -- периоды работы станции (может быть несколько, например, если станция надолго закрывалась ради ремонта), последовательность из сопоставлений:
* * `since` -- дата запуска
* * `to` -- дата остановки
* `lines` -- линии, к которым принадлежит станция (может быть несколько), последовательность из сопоставлений:
* * `name` -- название, должно совпадать с одним из ключей в lines.yaml
* * `since` -- дата запуска
* * `to` -- дата остановки
* `coords` -- географические координаты, сопоставление с ключами `lat` и `lon`

Скрипт пытается угадывать открытые даты, поэтому указывать их не обязательно. Станции отрисовываются от `since` включительно до `to` исключительно, с цветом, соответствующим линии на этот момент.

### 2. Секции

    - line: 8SL
      coords: 55.7362,37.5182,55.7491,37.5395
      since: 2014-01-31
      to: 2018-02-24

Последовательность из секций, каждая -- сопоставление с ключами:

* `line` -- название линии, ключ в lines.yaml
* `coords` -- через запятую пары координат, описывающих секцию. В минимальном варианте две пары
* `since` -- дата запуска участка
* `to` -- дата закрытия участка

Как и со станциями, скрипт угадывает открытые даты. В моём наборе данных координаты собраны по пусковым участкам, как [здесь](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BF%D1%83%D1%81%D0%BA%D0%BE%D0%B2%D1%8B%D1%85_%D1%83%D1%87%D0%B0%D1%81%D1%82%D0%BA%D0%BE%D0%B2_%D0%B8_%D0%BD%D0%BE%D0%B2%D1%8B%D1%85_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B9_%D0%9C%D0%BE%D1%81%D0%BA%D0%BE%D0%B2%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B5%D0%BD%D0%B0).  Станции соединяются прямыми отрезками, но технически ничто не мешает сделать линии более плавными и географически точными.

### 3. Линии

    1SL:
      color: ef161e

Сопоставление, в котором ключи -- сокращённые названия станций (номер и первые буквы названия латиницей). Внутри тоже сопоставления, пока из единственного ключа -- `color`, содержащего hex-код цвета линии.

## Web-мордочка

С некоторых пор, карту можно посмотреть в браузере. Здесь у нас наскоро слепленное, но рабочее поделие, состоящее из [Leaflet](https://leafletjs.com/), плагина [TimeDimension](https://github.com/socib/Leaflet.TimeDimension) для него и подложки [Stamen toner-lite](http://maps.stamen.com/). Демка: https://at8eqeq3.me/metro, можно также без особого труда положить `map.html`, `map.js` и `metro.json` себе на веб-сервер и зайти на http://<your.server>/map.html. С HTTPS чуть больше мороки, но ничего смертельного: оставлю пытливому читателю для самостоятельного решения, если понадобится.

Для сборки GeoJSON используется ruby-сценарий `to_geojson.rb`.
